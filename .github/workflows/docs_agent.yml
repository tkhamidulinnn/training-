name: ü§ñ Documentation Agent (Gemini)

on:
  pull_request:
    types: [opened, synchronize, labeled]
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Check out code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: 2. Gather Data (Dual Diff Strategy)
        id: file_data
        run: |
          git fetch origin ${{ github.base_ref }}
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # 1. FULL DIFF (–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ–≥–æ README - –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ PR)
            git diff origin/${{ github.base_ref }} HEAD -- . ":(exclude).github" ":(exclude).gitignore" > full_pr_diff.txt
            
            # 2. INCREMENTAL DIFF (–î–ª—è Change Log - —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç)
            # –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É, –∫–æ–≥–¥–∞ –±–æ—Ç –ø–µ—Ä–µ—á–∏—Å–ª—è–ª —Å—Ç–∞—Ä—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            git diff HEAD~1 HEAD -- . ":(exclude).github" ":(exclude).gitignore" > last_commit_diff.txt
          else
            echo "Manual run." > full_pr_diff.txt
            echo "Manual run." > last_commit_diff.txt
          fi

          if [ -f "README.md" ]; then
            cp README.md current_readme.txt
          else
            echo "README.md file not found." > current_readme.txt
          fi
          
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–µ—Ä–µ–≤–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
          git ls-files --exclude-standard | grep -v "^.github/" > file_tree.txt

      # ========================================================
      # üìù –ß–ê–°–¢–¨ 1: –ì–ï–ù–ï–†–ê–¶–ò–Ø CHANGE LOG (–¢–æ–ª—å–∫–æ —Å–≤–µ–∂–µ–µ)
      # ========================================================
      - name: 3. Generate Change Log
        id: changelog_gen
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cat <<'EOF_PROMPT' > changelog_prompt.txt
          # TASK: COMMIT ANALYST
          Analyze the [LAST COMMIT DIFF] and write a concise Change Log.
          
          # RULES:
          1. Focus ONLY on what changed in this specific commit.
          2. Use emojis (‚ú®, üêõ, üì¶, ‚öôÔ∏è).
          3. Format as a bulleted list.
          4. If the diff is empty or trivial, return "Minor updates."
          EOF_PROMPT

          jq -n \
            --rawfile diff last_commit_diff.txt \
            --rawfile prompt changelog_prompt.txt \
            '{ contents: [{ parts: [{ text: ($prompt + "\n\n## LAST COMMIT DIFF:\n" + $diff) }] }] }' > changelog_payload.json

          curl -s -H "Content-Type: application/json" \
               -d @changelog_payload.json \
               "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$GEMINI_API_KEY" > changelog_response.json

          jq -r '.candidates[0].content.parts[0].text' changelog_response.json > change_log.md

      # ========================================================
      # üîÑ –ß–ê–°–¢–¨ 2: –ì–ï–ù–ï–†–ê–¶–ò–Ø README (–ü–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞)
      # ========================================================
      - name: 4. Generate Full README
        id: readme_gen
        env:
          REPO_NAME: ${{ github.event.repository.name }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cat <<'EOF_PROMPT' > readme_prompt.txt
          # TASK: DOCUMENTATION ARCHITECT
          ## GOAL: Update `README.md` to be professional and visually appealing.
          
          ## VISUAL STANDARDS:
          1. **BADGES:** Under the title, add Shields.io badges for technologies found (Python, Docker, etc.).
          2. **FILE TREE:** Add a section `## üìÇ Project Structure` and visualize the provided FILE TREE.
          3. **TABLES:** Use Markdown Tables for Configuration and Dependencies.
          
          ## GOLDEN STRUCTURE:
          ---
          **[GOLDEN_TEMPLATE]**
          # PROJECT_NAME_PH
          
          [Badges Row]
          
          [Description]
          
          ## üìÇ Project Structure
          ```text
          [Insert Tree Here]
          ```

          ## 1. Table of Contents
          ## 2. About The Project
          ## 3. Installation
          ## 4. Usage
          ## 5. Configuration
          ## 6. API Reference
          ## 7. Deployment
          ## 8. Roadmap
          
          ## 9. License
          Copyright ¬© 2025 Grid Dynamics Holdings, Inc. All rights reserved.
          
          This software and associated documentation files (the "Software")
          are the confidential and proprietary information of Grid Dynamics
          Holdings, Inc. and may not be copied, reproduced, modified, published,
          uploaded, posted, transmitted, or distributed in any form or by any
          means without prior written permission.
          
          Unauthorized use, reproduction, or distribution of the Software or any
          portion of it may result in civil and criminal penalties.
          
          For questions regarding licensing or usage,
          contact legal_operations@griddynamics.com
          ---
          
          Output ONLY the Markdown content.
          EOF_PROMPT

          sed -i "s/PROJECT_NAME_PH/$REPO_NAME/g" readme_prompt.txt
          
          jq -n \
            --arg repo "$REPO_NAME" \
            --rawfile diff full_pr_diff.txt \
            --rawfile readme current_readme.txt \
            --rawfile filetree file_tree.txt \
            --rawfile prompt readme_prompt.txt \
            '{ contents: [{ parts: [{ text: ($prompt + "\n\n## FILE TREE:\n" + $filetree + "\n\n## CURRENT README:\n" + $readme + "\n\n## FULL PR DIFF:\n" + $diff) }] }] }' > readme_payload.json

          curl -s -H "Content-Type: application/json" -d @readme_payload.json "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$GEMINI_API_KEY" > readme_response.json
          
          jq -r '.candidates[0].content.parts[0].text' readme_response.json | sed 's/^```markdown//' | sed 's/^```//' | sed 's/```$//' > gemini_output.txt

      - name: 5. Decide Action (Smart Comment)
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            if (!fs.existsSync('gemini_output.txt')) return;
            
            const readmeContent = fs.readFileSync('gemini_output.txt', 'utf8');
            let summary = "Updated documentation.";
            
            if (fs.existsSync('change_log.md')) {
               summary = fs.readFileSync('change_log.md', 'utf8');
            }

            const labels = context.payload.pull_request ? context.payload.pull_request.labels.map(l => l.name) : [];
            const shouldCommit = labels.includes('generate-readme');

            if (shouldCommit) {
              console.log("LABEL FOUND! Writing file...");
              fs.writeFileSync('README.md', readmeContent);
            } else {
              console.log("Updating comment...");
              const header = "ü§ñ **Documentation Agent**";
              const body = `${header}\n\n### üìù Change Log (Latest Commit):\n${summary}\n\n---\nüëâ **Apply?** Add label **\`generate-readme\`**.\n\n<details><summary>üëÄ View README Preview</summary>\n\n\`\`\`markdown\n${readmeContent}\n\`\`\`\n</details>`;
              
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              const botComment = comments.find(c => c.body.includes(header));
              if (botComment) {
                await github.rest.issues.updateComment({ owner: context.repo.owner, repo: context.repo.repo, comment_id: botComment.id, body: body });
              } else {
                await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body: body });
              }
            }

      - name: 6. Commit Changes
        if: contains(github.event.pull_request.labels.*.name, 'generate-readme')
        run: |
          git config --global user.name "Gemini Docs Agent"
          git config --global user.email "actions@github.com"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "docs: auto-update README.md [skip ci]"
            git push
            curl -L -X DELETE -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "[https://api.github.com/repos/$](https://api.github.com/repos/$){{ github.repository }}/issues/${{ github.event.number }}/labels/generate-readme"
          fi

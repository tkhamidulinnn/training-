name: ðŸ¤– Documentation Agent (Gemini)

on:
  pull_request:
    types: [opened, synchronize, labeled]
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Check out code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: 2. Gather Data
        id: file_data
        run: |
          git fetch origin ${{ github.base_ref }}
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff origin/${{ github.base_ref }} HEAD -- . ":(exclude).github" ":(exclude).gitignore" > pr_diff.txt
          else
            echo "Not a PR (manual run)." > pr_diff.txt
          fi

          if [ -f "README.md" ]; then
            cp README.md current_readme.txt
          else
            echo "README.md file not found. Creating from scratch." > current_readme.txt
          fi
          
          git ls-files --exclude-standard | grep -v "^.github/" > file_tree.txt

      - name: 3. Call Gemini API (Robust Mode)
        id: gemini_call
        env:
          REPO_NAME: ${{ github.event.repository.name }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cat <<'EOF_PROMPT' > prompt_instructions.txt
          # TASK: DOCUMENTATION MAINTAINER
          ## GOAL: Update `README.md` based on code changes.
          
          ## INPUTS:
          1. **FILE TREE:** Current files (For context only).
          2. **DIFF:** Code changes.
          3. **CURRENT README:** Old content.
          
          ## RULES:
          1. **ALWAYS UPDATE:** Generate the full `README.md`.
          2. **INTEGRATION:** Merge new features into the existing structure.
          3. **NO DIAGRAMS:** Do NOT generate ASCII file trees, folder structures, or "schemes". The user hates them. Text only.
          
          ## GOLDEN STRUCTURE:
          ---
          **[GOLDEN_TEMPLATE]**
          # PROJECT_NAME_PH
          [Description]
          ## 1. Table of Contents
          ## 2. About The Project
          ## 3. Installation
          ## 4. Usage
          ## 5. Configuration
          ## 6. API Reference
          ## 7. Deployment
          ## 8. Roadmap
          ## 9. License
          Copyright Â© 2025 Grid Dynamics Holdings, Inc. All rights reserved.
          (License text...)
          ---
          
          Output ONLY the Markdown content. Do NOT include any intro text like "Here is the readme".
          EOF_PROMPT

          jq -n \

name: ü§ñ Documentation Agent (Gemini)

on:
  pull_request:
    types: [opened, synchronize, labeled]
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Check out code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: 2. Gather Data
        id: file_data
        run: |
          git fetch origin ${{ github.base_ref }}
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff origin/${{ github.base_ref }} HEAD -- . ":(exclude).github" ":(exclude).gitignore" > pr_diff.txt
          else
            echo "Not a PR (manual run)." > pr_diff.txt
          fi

          if [ -f "README.md" ]; then
            cp README.md current_readme.txt
          else
            echo "README.md file not found." > current_readme.txt
          fi
          
          git ls-files --exclude-standard | grep -v "^.github/" > file_tree.txt

      # ========================================================
      # üÜï –ß–ê–°–¢–¨ 1: –ì–ï–ù–ï–†–ê–¶–ò–Ø –û–ü–ò–°–ê–ù–ò–Ø –ü–£–õ-–†–ï–ö–í–ï–°–¢–ê
      # ========================================================
      - name: 3. Generate PR Description
        id: pr_gen
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cat <<'EOF_PROMPT' > pr_prompt_header.txt
          # TASK: PR DESCRIPTION WRITER
          Generate a professional Pull Request description.
          # OUTPUT FORMAT (Markdown):
          ## üöÄ Summary
          [1 sentence summary]
          ## üõ† Key Changes
          * [Bullet point]
          ## üß™ Testing
          [How to test]
          # RULE: Concise, emojis, markdown only.
          
          ## CODE DIFF:
          EOF_PROMPT

          # –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –≤ —Ñ–∞–π–ª
          cat pr_prompt_header.txt pr_diff.txt > pr_full_input.txt

          # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ —Ü–µ–ª–∏–∫–æ–º (–±–µ–∑ —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏ –∫–∞–≤—ã—á–µ–∫ –≤ jq)
          jq -n --rawfile text pr_full_input.txt '{ contents: [{ parts: [{ text: $text }] }] }' > pr_payload.json

          curl -s -H "Content-Type: application/json" \
               -d @pr_payload.json \
               "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$GEMINI_API_KEY" > pr_response.json

          jq -r '.candidates[0].content.parts[0].text' pr_response.json > pr_desc.md

      - name: 4. Update PR Body
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            if (!fs.existsSync('pr_desc.md')) return;
            const newBody = fs.readFileSync('pr_desc.md', 'utf8');
            
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body: newBody
            });

      # ========================================================
      # üîÑ –ß–ê–°–¢–¨ 2: –ì–ï–ù–ï–†–ê–¶–ò–Ø README (–ë–ï–ó–û–ü–ê–°–ù–ê–Ø –°–ë–û–†–ö–ê)
      # ========================================================
      - name: 5. Generate README
        id: readme_gen
        env:
          REPO_NAME: ${{ github.event.repository.name }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1. –°–æ–∑–¥–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
          cat <<'EOF_PROMPT' > readme_instructions.txt
          # TASK: DOCUMENTATION MAINTAINER
          ## RULES:
          1. **ALWAYS UPDATE:** Generate full README.
          2. **INTEGRATION:** Merge new features.
          
          ## GOLDEN STRUCTURE:
          ---
          **[GOLDEN_TEMPLATE]**
          # PROJECT_NAME_PH
          [Description]
          ## 1. Table of Contents
          ## 2. About The Project
          ## 3. Installation
          ## 4. Usage
          ## 5. Configuration
          ## 6. API Reference
          ## 7. Deployment
          ## 8. Roadmap
          ## 9. License
          Copyright ¬© 2025 Grid Dynamics Holdings, Inc. All rights reserved.
          (Standard License Text...)
          ---
          
          ## OUTPUT FORMAT:
          Split response with "---SPLIT---".
          **PART 1: CHANGE LOG**
          ---SPLIT---
          **PART 2: FULL README**
          EOF_PROMPT

          # –ó–∞–º–µ–Ω—è–µ–º –∏–º—è –ø—Ä–æ–µ–∫—Ç–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º sed
          sed -i "s/PROJECT_NAME_PH/$REPO_NAME/g" readme_instructions.txt

          # 2. –°–æ–±–∏—Ä–∞–µ–º –û–î–ò–ù –±–æ–ª—å—à–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª (Concatenation)
          # –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ Bash —Å –∫–∞–≤—ã—á–∫–∞–º–∏
          cat readme_instructions.txt > full_prompt.txt
          echo -e "\n\n## FILES TREE:\n" >> full_prompt.txt
          cat file_tree.txt >> full_prompt.txt
          echo -e "\n\n## CURRENT README:\n" >> full_prompt.txt
          cat current_readme.txt >> full_prompt.txt
          echo -e "\n\n## CODE DIFF:\n" >> full_prompt.txt
          cat pr_diff.txt >> full_prompt.txt

          # 3. –£–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –≤ JSON —Å –ø–æ–º–æ—â—å—é --rawfile (jq –ø—Ä–æ—Å—Ç–æ —á–∏—Ç–∞–µ—Ç —Ñ–∞–π–ª –∫–∞–∫ —Å—Ç—Ä–æ–∫—É)
          jq -n --rawfile prompt full_prompt.txt '{ contents: [{ parts: [{ text: $prompt }] }] }' > readme_payload.json

          curl -s -H "Content-Type: application/json" -d @readme_payload.json "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$GEMINI_API_KEY" > readme_response.json

          jq -r '.candidates[0].content.parts[0].text' readme_response.json | sed 's/^```json//' | sed 's/^```//' | sed 's/```$//' > gemini_output.txt

      - name: 6. Decide Action (Comment/Commit)
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            if (!fs.existsSync('gemini_output.txt')) return;
            const fullOutput = fs.readFileSync('gemini_output.txt', 'utf8');
            
            const separator = "---SPLIT---";
            let summary = "Documentation updated.";
            let readmeContent = fullOutput;

            if (fullOutput.includes(separator)) {
               const parts = fullOutput.split(separator);
               summary = parts[0].trim();
               readmeContent = parts[1].trim();
            }

            const labels = context.payload.pull_request ? context.payload.pull_request.labels.map(l => l.name) : [];
            const shouldCommit = labels.includes('generate-readme');

            if (shouldCommit) {
              console.log("LABEL FOUND! Writing file...");
              fs.writeFileSync('README.md', readmeContent);
            } else {
              const body = "ü§ñ **Documentation Agent**\n\n" +
                           "### üìù –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å (Change Log):\n" +
                           summary + "\n\n" +
                           "--- \n" +
                           "üëâ **–ß—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å:** –ü–æ—Å—Ç–∞–≤—å—Ç–µ –º–µ—Ç–∫—É **`generate-readme`**.\n\n" +
                           "<details><summary>üëÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–ª–Ω—ã–π README.md</summary>\n\n" +
                           "```markdown\n" + readmeContent + "\n```\n" +
                           "</details>";
              
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: 7. Commit Changes
        if: contains(github.event.pull_request.labels.*.name, 'generate-readme')
        run: |
          git config --global user.name "Gemini Docs Agent"
          git config --global user.email "actions@github.com"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "docs: auto-update README.md [skip ci]"
            git push
            curl -L -X DELETE -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "[https://api.github.com/repos/$](https://api.github.com/repos/$){{ github.repository }}/issues/${{ github.event.number }}/labels/generate-readme"
          fi

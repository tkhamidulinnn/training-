name: ü§ñ Documentation Agent (Version 44.0 - Strict & Clean)

on:
  pull_request:
    types: [opened, synchronize, labeled]
  workflow_dispatch:
    inputs:
      mode:
        description: 'Run Mode'
        default: 'diff'
        type: choice
        options:
        - diff

permissions:
  pull-requests: write
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Check out code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: 2. Gather Data
        id: file_data
        run: |
          git fetch origin ${{ github.base_ref }}
          
          # 1. DIFF (–ò–∑–º–µ–Ω–µ–Ω–∏—è)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
             git diff origin/${{ github.base_ref }} HEAD -- . ":(exclude).github" ":(exclude).gitignore" > pr_diff.txt
          else
             echo "Manual Run" > pr_diff.txt
          fi

          # 2. CONTEXT (–°—Ç—Ä—É–∫—Ç—É—Ä–∞)
          echo "## PROJECT STRUCTURE:" > context.txt
          git ls-files --exclude-standard | grep -v "^.github/" | head -n 100 >> context.txt
          
          # 3. OLD README
          if [ -f "README.md" ]; then
            cp README.md current_readme.txt
          else
            echo "No README found." > current_readme.txt
          fi

      - name: 3. Call Gemini API (Strict Mode)
        id: gemini_call
        env:
          REPO_NAME: ${{ github.event.repository.name }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cat <<'EOF_PROMPT' > prompt.txt
          # ROLE: Documentation Assistant
          
          ## INPUTS:
          1. **DIFF:** Code changes.
          2. **OLD README:** Current docs.
          
          ## TASK 1: THE COMMENT (Log Only)
          Analyze the DIFF and create a concise summary.
          
          **‚õî STRICT CONSTRAINTS:**
          - **ABSOLUTELY NO** full file content in this section.
          - **NO** long paragraphs.
          - **ONLY** bullet points grouped by file.
          
          **FORMAT for Change Log:**
          ### üìÇ `[Filename]`
          - **Change:** [Action] [Detail]
          - **Reason:** [Brief Why]
          
          ## TASK 2: THE FILE (For Commit)
          Generate the FULL updated README.md content integrating the changes.
          
          ## OUTPUT WRAPPER:
          START_CHANGE_LOG
          (Insert ONLY the concise summary here)
          END_CHANGE_LOG
          
          START_README
          (Insert the FULL updated README content here)
          END_README
          EOF_PROMPT

          sed -i "s/PROJECT_NAME_PH/$REPO_NAME/g" prompt.txt
          
          cat prompt.txt > full_input.txt
          echo -e "\n\n## CONTEXT:\n" >> full_input.txt
          cat context.txt >> full_input.txt
          echo -e "\n\n## CURRENT README:\n" >> full_input.txt
          cat current_readme.txt >> full_input.txt
          echo -e "\n\n## DIFF:\n" >> full_input.txt
          cat pr_diff.txt >> full_input.txt

          jq -n --rawfile text full_input.txt '{ contents: [{ parts: [{ text: $text }] }] }' > payload.json
          
          curl -s -H "Content-Type: application/json" -d @payload.json "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=$GEMINI_API_KEY" > response.json
          
          jq -r '.candidates[0].content.parts[0].text' response.json > gemini_full_response.txt

      - name: 4. Process Response
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            if (!fs.existsSync('gemini_full_response.txt')) return;
            
            const fullText = fs.readFileSync('gemini_full_response.txt', 'utf8');
            
            let changeLog = "Updates detected.";
            let readme = "";

            if (fullText.includes('START_CHANGE_LOG') && fullText.includes('END_CHANGE_LOG')) {
                changeLog = fullText.split('START_CHANGE_LOG')[1].split('END_CHANGE_LOG')[0].trim();
            }
            if (fullText.includes('START_README') && fullText.includes('END_README')) {
                readme = fullText.split('START_README')[1].split('END_README')[0].trim();
            }

            // 1. –ï—Å–ª–∏ –µ—Å—Ç—å –º–µ—Ç–∫–∞ - –æ–±–Ω–æ–≤–ª—è–µ–º —Ñ–∞–π–ª
            const labels = context.payload.pull_request ? context.payload.pull_request.labels.map(l => l.name) : [];
            if (labels.includes('generate-readme') && readme) {
                console.log("Writing new README file...");
                fs.writeFileSync('README.md', readme);
            } 
            
            // 2. –í—Å–µ–≥–¥–∞ –ø–∏—à–µ–º –¢–û–õ–¨–ö–û –∫—Ä–∞—Ç–∫–∏–π –ª–æ–≥ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            // –ù–∏–∫–∞–∫–æ–≥–æ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, –Ω–∏–∫–∞–∫–∏—Ö —Å–ø–æ–π–ª–µ—Ä–æ–≤.
            if (changeLog) {
                const body = `ü§ñ **Documentation Update**\n\n${changeLog}`;
                
                await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    body: body
                });
            }

      - name: 5. Commit & Push
        if: contains(github.event.pull_request.labels.*.name, 'generate-readme')
        run: |
          git config --global user.name "Gemini Docs Agent"
          git config --global user.email "actions@github.com"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes."
          else
            git commit -m "docs: auto-update README.md [skip ci]"
            git push
          fi

      - name: 6. Cleanup Label
        if: always() && contains(github.event.pull_request.labels.*.name, 'generate-readme')
        uses: actions/github-script@v6
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'generate-readme'
              });
            } catch (e) {}

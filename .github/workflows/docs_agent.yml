name: ü§ñ Documentation Agent (v42 - Full Features)

on:
  pull_request:
    types: [opened, synchronize, labeled]
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Check out code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: 2. Gather Data
        id: file_data
        run: |
          git fetch origin ${{ github.base_ref }}
          
          # –°–æ–±–∏—Ä–∞–µ–º Diff
          if [ "${{ github.event_name }}" == "pull_request" ]; then
             git diff origin/${{ github.base_ref }} HEAD -- . ":(exclude).github" ":(exclude).gitignore" > pr_diff.txt
          else
             echo "Manual Run" > pr_diff.txt
          fi

          # –ß–∏—Ç–∞–µ–º README
          if [ -f "README.md" ]; then
            cp README.md current_readme.txt
          else
            echo "No README found." > current_readme.txt
          fi

      - name: 3. Call Gemini API (Smart Split)
        id: gemini_call
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # –ß–∏—Å—Ç–∏–º –∫–ª—é—á –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
          CLEAN_KEY=$(echo "$GEMINI_API_KEY" | tr -d '[:space:]')

          # –ü—Ä–æ–º–ø—Ç –ø—Ä–æ—Å–∏—Ç —Ä–∞–∑–¥–µ–ª–∏—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ –¥–≤–µ —á–∞—Å—Ç–∏: –õ–û–ì –∏ –ü–û–õ–ù–´–ô –¢–ï–ö–°–¢
          cat <<'EOF_PROMPT' > prompt.txt
          Role: Technical Writer.
          Task: Analyze code changes and update README.md.
          
          Input 1 (Current README):
          (See below)
          
          Input 2 (Code Changes):
          (See below)
          
          OUTPUT FORMAT:
          You must split your response into two parts using the separator "---SPLIT---".
          
          PART 1: Change Log.
          A bulleted list of changes grouped by filename (e.g., üìÇ filename).
          
          ---SPLIT---
          
          PART 2: Full README.
          The complete, updated markdown content of the README.md file.
          EOF_PROMPT
          
          cat prompt.txt > full_input.txt
          echo -e "\n\n=== CURRENT README ===\n" >> full_input.txt
          cat current_readme.txt >> full_input.txt
          echo -e "\n\n=== DIFF ===\n" >> full_input.txt
          cat pr_diff.txt >> full_input.txt

          jq -n --rawfile text full_input.txt '{ contents: [{ parts: [{ text: $text }] }] }' > payload.json
          
          # –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
          curl -s -H "Content-Type: application/json" \
            -d @payload.json \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=$CLEAN_KEY" \
            > response.json
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç
          jq -r '.candidates[0].content.parts[0].text // empty' response.json | sed 's/^```markdown//' | sed 's/^```//' | sed 's/```$//' > gemini_full_response.txt

      - name: 4. Process & Comment
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            if (!fs.existsSync('gemini_full_response.txt')) return;
            
            const fullResponse = fs.readFileSync('gemini_full_response.txt', 'utf8');
            
            // –†–∞–∑–¥–µ–ª—è–µ–º –æ—Ç–≤–µ—Ç –Ω–∞ –õ–æ–≥ –∏ –§–∞–π–ª
            const separator = "---SPLIT---";
            let changeLog = "Updates detected.";
            let newReadme = fullResponse;

            if (fullResponse.includes(separator)) {
               const parts = fullResponse.split(separator);
               changeLog = parts[0].trim(); // –õ–æ–≥ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
               newReadme = parts[1].trim(); // –§–∞–π–ª –¥–ª—è –∑–∞–ø–∏—Å–∏
            }
            
            // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (–æ—à–∏–±–∫–∞) - –≤—ã—Ö–æ–¥–∏–º
            if (!newReadme || newReadme.length < 50) return;

            const labels = context.payload.pull_request ? context.payload.pull_request.labels.map(l => l.name) : [];
            
            if (labels.includes('generate-readme')) {
                // –ú–ï–¢–ö–ê –ï–°–¢–¨ -> –ü–ò–®–ï–ú –§–ê–ô–õ
                console.log("Writing README.md");
                fs.writeFileSync('README.md', newReadme);
            } else {
                // –ú–ï–¢–ö–ò –ù–ï–¢ -> –ü–ò–®–ï–ú –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô
                // –í–æ—Ç —Ç—É—Ç –º–∞–≥–∏—è: –õ–æ–≥ –≤–∏–¥–µ–Ω —Å—Ä–∞–∑—É, –∞ –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–∫—Ä—ã—Ç
                console.log("Posting comment");
                
                const body = `ü§ñ **Documentation Update Analysis**\n\n` +
                             `${changeLog}\n\n` +
                             `---\n` +
                             `üëâ **To apply:** Add label \`generate-readme\`.\n\n` +
                             `<details><summary>üìú **Preview Full Generated README** (Click to expand)</summary>\n\n` +
                             `\`\`\`markdown\n${newReadme}\n\`\`\`\n` +
                             `</details>`;
                
                await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    body: body
                });
            }

      - name: 5. Commit & Push (Safe Rebase)
        if: contains(github.event.pull_request.labels.*.name, 'generate-readme')
        run: |
          git config --global user.name "Gemini Docs Agent"
          git config --global user.email "actions@github.com"
          
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes."
          else
            git commit -m "docs: auto-update README.md [skip ci]"
            
            # Rebase - —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –≤–∞—à–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            git pull origin ${{ github.event.pull_request.head.ref }} --rebase --autostash
            
            git push origin HEAD:${{ github.event.pull_request.head.ref }}
          fi

      - name: 6. Cleanup Label
        if: always() && contains(github.event.pull_request.labels.*.name, 'generate-readme')
        uses: actions/github-script@v6
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'generate-readme'
              });
            } catch (e) {}

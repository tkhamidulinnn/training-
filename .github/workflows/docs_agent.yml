name: ü§ñ Documentation Agent (Gemini)

on:
  pull_request:
    types: [opened, synchronize, labeled]
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Check out code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: 2. Gather Data (Dual Diff Strategy)
        id: file_data
        run: |
          git fetch origin ${{ github.base_ref }}
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # 1. –ü–û–õ–ù–´–ô –î–ò–§–§ (–î–ª—è README)
            git diff origin/${{ github.base_ref }} HEAD -- . ":(exclude).github" ":(exclude).gitignore" > full_pr_diff.txt
            
            # 2. –ò–ù–ö–†–ï–ú–ï–ù–¢–ê–õ–¨–ù–´–ô –î–ò–§–§ (–î–ª—è Change Log)
            git diff HEAD~1 HEAD -- . ":(exclude).github" ":(exclude).gitignore" > last_commit_diff.txt
          else
            echo "Manual run." > full_pr_diff.txt
            echo "Manual run." > last_commit_diff.txt
          fi

          if [ -f "README.md" ]; then
            cp README.md current_readme.txt
          else
            echo "README.md file not found." > current_readme.txt
          fi
          
          git ls-files --exclude-standard | grep -v "^.github/" > file_tree.txt

      - name: 3. Call Gemini API (Fixed Model)
        id: gemini_call
        env:
          REPO_NAME: ${{ github.event.repository.name }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cat <<'EOF_PROMPT' > prompt_instructions.txt
          # TASK: DOCUMENTATION MAINTAINER
          
          ## INPUTS:
          1. **LAST COMMIT DIFF:** Use this for the "CHANGE LOG".
          2. **FULL PR DIFF:** Use this for the "README".
          3. **CURRENT README:** Old content.
          
          ## GOAL:
          Generate a specific Change Log and a fully updated README.
          
          ## RULES (CRITICAL):
          1. **ALWAYS UPDATE:** Generate the full `README.md`.
          2. **INTEGRATION:** Merge new features into the existing structure.
          3. **NO VISUALIZATIONS:**
             - **NO ASCII FILE TREES.** Do NOT draw the folder structure.
             - **NO BADGES.** Do not add status shields.
             - **NO "PROJECT STRUCTURE" SECTION.** Skip this section entirely.
          4. **NO TABLES:**
             - **Do NOT use Markdown tables** (rows/columns).
             - Use bullet points or lists for all data presentation.
          
          ## OUTPUT FORMAT:
          Split response with "---SPLIT---".
          
          **PART 1: CHANGE LOG**
          (Bulleted list describing ONLY changes found in [LAST COMMIT DIFF]. Be specific.)
          
          ---SPLIT---
          
          **PART 2: FULL README**
          (The complete documentation covering EVERYTHING).
          
          ## GOLDEN STRUCTURE:
          ---
          **[GOLDEN_TEMPLATE]**
          # PROJECT_NAME_PH
          [Description]
          ## 1. Table of Contents
          ## 2. About The Project
          ## 3. Installation
          ## 4. Usage
          ## 5. Configuration
          ## 6. API Reference
          ## 7. Deployment
          ## 8. Roadmap
          ## 9. License
          Copyright ¬© 2025 Grid Dynamics Holdings, Inc. All rights reserved.
          (License text...)
          ---
          EOF_PROMPT

          sed -i "s/PROJECT_NAME_PH/$REPO_NAME/g" prompt_instructions.txt
          
          jq -n \
            --arg repo "$REPO_NAME" \
            --rawfile last_commit last_commit_diff.txt \
            --rawfile full_diff full_pr_diff.txt \
            --rawfile readme current_readme.txt \
            --rawfile filetree file_tree.txt \
            --rawfile prompt prompt_instructions.txt \
            '{
              contents: [{
                parts: [{
                  text: ($prompt + "\n\n## [LAST COMMIT DIFF] (For Change Log):\n" + $last_commit + "\n\n## [FULL PR DIFF] (For README):\n" + $full_diff + "\n\n## CURRENT README:\n" + $readme + "\n\n## FILE TREE (CONTEXT ONLY - DO NOT DRAW):\n" + $filetree)
                }]
              }]
            }' > payload.json

          # –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º gemini-1.5-flash-latest –≤–º–µ—Å—Ç–æ gemini-1.5-flash
          curl -s -H "Content-Type: application/json" \
               -d @payload.json \
               "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=$GEMINI_API_KEY" > response.json

          if jq -e '.error' response.json > /dev/null; then
            echo "Error returned from API:"
            cat response.json
            exit 1
          fi

          jq -r '.candidates[0].content.parts[0].text' response.json | sed 's/^```json//' | sed 's/^```//' | sed 's/```$//' > gemini_output.txt

          if [ ! -s gemini_output.txt ] || grep -q "null" gemini_output.txt; then
             echo "Error: API returned empty."
             exit 1
          fi

      - name: 4. Decide Action
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            if (!fs.existsSync('gemini_output.txt')) return;
            const fullOutput = fs.readFileSync('gemini_output.txt', 'utf8');
            
            const separator = "---SPLIT---";
            let summary = "Documentation updated.";
            let readmeContent = fullOutput;

            if (fullOutput.includes(separator)) {
               const parts = fullOutput.split(separator);
               summary = parts[0].trim();
               readmeContent = parts[1].trim();
            }

            const labels = context.payload.pull_request ? context.payload.pull_request.labels.map(l => l.name) : [];
            const shouldCommit = labels.includes('generate-readme');

            if (shouldCommit) {
              console.log("LABEL FOUND! Writing file...");
              fs.writeFileSync('README.md', readmeContent);
            } else {
              console.log("Updating comment...");
              const header = "ü§ñ **Documentation Agent**";
              const body = `${header}\n\n### üìù –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤

name: ü§ñ Documentation Agent (Gemini)

on:
  pull_request:
    types: [opened, synchronize, labeled]
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Check out code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: 2. Gather Data
        id: file_data
        run: |
          git fetch origin ${{ github.base_ref }}
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff origin/${{ github.base_ref }} HEAD -- . ":(exclude).github" ":(exclude).gitignore" > pr_diff.txt
          else
            echo "Not a PR (manual run)." > pr_diff.txt
          fi

          if [ -f "README.md" ]; then
            cp README.md current_readme.txt
          else
            echo "README.md file not found. Creating from scratch." > current_readme.txt
          fi
          
          git ls-files --exclude-standard | grep -v "^.github/" > file_tree.txt

      - name: 3. Call Gemini API (JSON Mode)
        id: gemini_call
        env:
          REPO_NAME: ${{ github.event.repository.name }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cat <<'EOF_PROMPT' > prompt_instructions.txt
          # TASK: DOCUMENTATION MAINTAINER
          ## GOAL: Analyze code changes and generate: 1) A summary of changes, 2) The updated README.
          
          ## INPUTS:
          1. **FILE TREE:** Current files.
          2. **DIFF:** Code changes.
          3. **CURRENT README:** Old content.
          
          ## RULES:
          1. **ALWAYS UPDATE:** Generate the full `README.md`.
          2. **INTEGRATION:** Merge new features into the existing structure.
          
          ## OUTPUT FORMAT (JSON ONLY):
          You must respond with a valid JSON object containing exactly two keys:
          {
            "summary": "A bulleted list (string) describing top 3-5 changes. Use emojis.",
            "readme": "The full markdown content of the new README.md"
          }
          
          ## GOLDEN STRUCTURE FOR README:
          ---
          **[GOLDEN_TEMPLATE]**
          # PROJECT_NAME_PH
          [Description]
          ## 1. Table of Contents
          ## 2. About The Project
          ## 3. Installation
          ## 4. Usage
          ## 5. Configuration
          ## 6. API Reference
          ## 7. Deployment
          ## 8. Roadmap
          ## 9. License
          Copyright ¬© 2025 Grid Dynamics Holdings, Inc. All rights reserved.
          (License text...)
          ---
          
          **IMPORTANT:** Do not wrap the output in markdown code blocks (like ```json). Just output raw JSON.
          EOF_PROMPT

          jq -n \
            --arg repo "$REPO_NAME" \
            --rawfile diff pr_diff.txt \
            --rawfile readme current_readme.txt \
            --rawfile filetree file_tree.txt \
            --rawfile prompt prompt_instructions.txt \
            '{
              contents: [{
                parts: [{
                  text: ($prompt | sub("PROJECT_NAME_PH"; $repo) + "\n\n## CURRENT FILE TREE:\n" + $filetree + "\n\n## CURRENT README:\n" + $readme + "\n\n## PR DIFF:\n" + $diff + "\n---")
                }]
              }]
            }' > payload.json

          curl -s -H "Content-Type: application/json" \
               -d @payload.json \
               "[https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$GEMINI_API_KEY](https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$GEMINI_API_KEY)" > response.json

          if jq -e '.error' response.json > /dev/null; then
            echo "Error returned from API:"
            cat response.json
            exit 1
          fi

          # 1. –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç (–∫–æ—Ç–æ—Ä—ã–π —è–≤–ª—è–µ—Ç—Å—è JSON-—Å—Ç—Ä–æ–∫–æ–π)
          jq -r '.candidates[0].content.parts[0].text' response.json | sed 's/^```json//' | sed 's/^```//' | sed 's/```$//' > raw_content.json

          # 2. –ü–∞—Ä—Å–∏–º —ç—Ç–æ—Ç JSON –Ω–∞ –¥–≤–∞ —Ñ–∞–π–ª–∞: summary.txt –∏ gemini_output.txt
          if jq -e . raw_content.json > /dev/null 2>&1; then
             jq -r '.summary' raw_content.json > summary.txt
             jq -r '.readme' raw_content.json > gemini_output.txt
          else
             echo "Error: Gemini response was not valid JSON. Falling back to raw text."
             cat raw_content.json > gemini_output.txt
             echo "Documentation updated." > summary.txt
          fi

          if [ ! -s gemini_output.txt ] || grep -q "null" gemini_output.txt; then
             echo "Error: API returned empty."
             exit 1
          fi

      - name: 4. Decide Action (With Summary)
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            if (!fs.existsSync('gemini_output.txt')) {
               console.log("Error: Output file not found.");
               return;
            }
            
            const output = fs.readFileSync('gemini_output.txt', 'utf8');
            // –ß–∏—Ç–∞–µ–º —Å–∞–º–º–∞—Ä–∏, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
            let summary = "Documentation updated based on code changes.";
            if (fs.existsSync('summary.txt')) {
               summary = fs.readFileSync('summary.txt', 'utf8');
            }

            const labels = context.payload.pull_request ? context.payload.pull_request.labels.map(l => l.name) : [];
            const shouldCommit = labels.includes('generate-readme');

            if (shouldCommit) {
              console.log("LABEL FOUND! Writing file...");
              fs.writeFileSync('README.md', output);
            } else {
              console.log("No label found. Posting comment.");
              
              const body = "ü§ñ **Documentation Agent**\n\n" +
                           "### üìù –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å (Change Log):\n" +
                           summary + "\n\n" +
                           "--- \n" +
                           "üëâ **–ü—Ä–∏–º–µ–Ω–∏—Ç—å?** –ü–æ—Å—Ç–∞–≤—å—Ç–µ –º–µ—Ç–∫—É **`generate-readme`**.\n\n" +
                           "<details><summary>üëÄ –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—ã–π README</summary>\n\n" +
                           "```markdown\n" + output + "\n```\n" +
                           "</details>";
              
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: 5. Commit Changes
        if: contains(github.event.pull_request.labels.*.name, 'generate-readme')
        run: |
          git config --global user.name "Gemini Docs Agent"
          git config --global user.email "actions@github.com"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "docs: auto-update README.md [skip ci]"
            git push
            curl -L -X DELETE -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.number }}/labels/generate-readme"
          fi

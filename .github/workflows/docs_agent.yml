name: ü§ñ Documentation Agent (Production v50)

on:
  pull_request:
    types: [opened, synchronize, labeled]
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: write
  issues: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Check out code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: 2. Gather Data
        id: file_data
        run: |
          git fetch origin ${{ github.base_ref }}
          
          # 1. –°–±–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π (Diff)
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff origin/${{ github.base_ref }} HEAD -- . ":(exclude).github" ":(exclude).gitignore" > pr_diff.txt
          else
            echo "Not a PR (manual run)." > pr_diff.txt
          fi

          # 2. –°–±–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ README
          if [ -f "README.md" ]; then
            cp README.md current_readme.txt
          else
            echo "README.md file not found." > current_readme.txt
          fi
          
          # 3. –°–±–æ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ñ–∞–π–ª–æ–≤
          git ls-files --exclude-standard | grep -v "^.github/" > file_tree.txt

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ diff (—á—Ç–æ–±—ã –Ω–µ –≥–æ–Ω—è—Ç—å –ò–ò –≤–ø—É—Å—Ç—É—é)
          if [ ! -s pr_diff.txt ]; then
            echo "‚ö†Ô∏è No changes detected."
          fi

      - name: 3. Call Gemini API (Safe Mode)
        id: gemini_call
        env:
          REPO_NAME: ${{ github.event.repository.name }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # --- –ü–†–û–í–ï–†–ö–ê –ö–õ–Æ–ß–ê (–í–ê–ñ–ù–û!) ---

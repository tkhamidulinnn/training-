name: ðŸ¤– Documentation Agent (Gemini)

on:
  pull_request:
    types: [opened, synchronize, labeled]
  workflow_dispatch:
    inputs:
      mode:
        description: 'Scan Mode'
        required: true
        default: 'diff'
        type: choice
        options:
        - diff
        - full_scan

permissions:
  pull-requests: write
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Check out code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: 2. Gather Data
        id: file_data
        run: |
          # Fetch base branch safely
          git fetch origin ${{ github.base_ref }} || true
          
          MODE="${{ github.event.inputs.mode }}"
          if [ "${{ github.event_name }}" == "pull_request" ]; then
             MODE="diff"
          fi
          
          echo "ðŸš€ Running in mode: $MODE"

          if [ "$MODE" == "diff" ]; then
             git diff origin/${{ github.base_ref }} HEAD -- . ":(exclude).github" ":(exclude).gitignore" > pr_diff.txt
          elif [ "$MODE" == "full_scan" ]; then
             find . -maxdepth 4 -not -path '*/.*' -not -path './node_modules*' | grep -E "\.(py|js|ts|go|java|md|json)$" > all_files_list.txt
             echo "FULL REPOSITORY SCAN:" > pr_diff.txt
             while read -r file; do
               echo "--- FILE: $file ---" >> pr_diff.txt
               cat "$file" >> pr_diff.txt
               echo "" >> pr_diff.txt
             done < all_files_list.txt
          else
             echo "No changes." > pr_diff.txt
          fi

          if [ -f "README.md" ]; then
            cp README.md current_readme.txt
          else
            echo "README.md file not found." > current_readme.txt
          fi
          
          git ls-files --exclude-standard | grep -v "^.github/" > file_tree.txt || true

      - name: 3. Generate PR Description
        if: github.event_name == 'pull_request'
        id: pr_desc_gen
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cat <<'EOF_PROMPT' > pr_prompt.txt
          # TASK: PR UPDATE WRITER
          Generate a short update block for the Pull Request description.
          # OUTPUT FORMAT:
          ### ðŸ”„ Update (__DATE__)
          * [Bullet point 1]
          * [Bullet point 2]
          # RULE: Keep it very short.
          EOF_PROMPT
          
          CURRENT_DATE=$(date +'%Y-%m-%d %H:%M')
          sed -i "s/__DATE__/$CURRENT_DATE/g" pr_prompt.txt

          # Ð Ð°Ð·Ð±Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð»Ð¸Ð½Ð½ÑƒÑŽ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ jq Ð½Ð° Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ ÑÑ‚Ñ€Ð¾Ðº Ð´Ð»Ñ Ð½Ð°Ð´ÐµÐ¶Ð½Ð¾ÑÑ‚Ð¸
          jq -n \
            --rawfile diff pr_diff.txt \
            --rawfile prompt pr_prompt.txt \
            '{ contents: [{ parts: [{ text: ($prompt + "\n\n## DIFF:\n" + $diff) }] }] }' > pr_payload.json

          curl -s -H "Content-Type: application/json" \
               -d @pr_payload.json \
               "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$GEMINI_API_KEY" > pr_response.json
          
          jq -r '.candidates[0].content.parts[0].text' pr_response.json > pr_update_block.md

      - name: 4. Update PR Body
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            if (!fs.existsSync('pr_update_block.md')) return;
            const newBlock = fs.readFileSync('pr_update_block.md', 'utf8');
            const { data: pr } = await github.rest.pulls.get({ owner: context.repo.owner, repo: context.repo.repo, pull_number: context.issue.number });
            let currentBody = pr.body || "";
            if (!currentBody.includes("## ðŸš€ AI Summary Log")) { currentBody = "## ðŸš€ AI Summary Log\n" + currentBody; }
            const updatedBody = currentBody.replace("## ðŸš€ AI Summary Log", "## ðŸš€ AI Summary Log\n\n" + newBlock);
            await github.rest.pulls.update({ owner: context.repo.owner, repo: context.repo.repo, pull_number: context.issue.number, body: updatedBody });

      - name: 5. Generate README
        id: gemini_readme
        env:
          REPO_NAME: ${{ github.event.repository.name }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cat <<'EOF_PROMPT' > readme_prompt.txt
          # TASK: DOCUMENTATION MAINTAINER
          ## RULES:
          1. **ALWAYS UPDATE:** Generate the full `README.md`.
          2. **INTEGRATION:** Merge new features.
          
          ## OUTPUT FORMAT:
          Split response with "---SPLIT---".
          **PART 1: CHANGE LOG** (Summary)
          ---SPLIT---
          **PART 2: FULL README** (Markdown content)
          
          ## GOLDEN STRUCTURE:
          ---
          **[GOLDEN_TEMPLATE]**
          # PROJECT_NAME_PH
          [Description]
          ## 1. Table of Contents
          ## 2. About The Project
          ## 3. Installation
          ## 4. Usage
          ## 5. Configuration
          ## 6. API Reference
          ## 7. Deployment
          ## 8. Roadmap
          ## 9. License
          Copyright Â© 2025 Grid Dynamics Holdings, Inc. All rights reserved.
          (Standard License Text...)
          ---
          EOF_PROMPT

          sed -i "s

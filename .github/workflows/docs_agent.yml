name: ü§ñ Documentation Agent (Gemini)

on:
  pull_request:
    types: [opened, synchronize, labeled]
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Check out code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: 2. Gather Data
        id: file_data
        run: |
          git fetch origin ${{ github.base_ref }}
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # 1. –ü–æ–ª–Ω—ã–π –¥–∏—Ñ—Ñ (–¥–ª—è README)
            git diff origin/${{ github.base_ref }} HEAD -- . ":(exclude).github" ":(exclude).gitignore" > full_pr_diff.txt
            
            # 2. –î–∏—Ñ—Ñ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–º–º–∏—Ç–∞ (–¥–ª—è Change Log)
            git diff HEAD~1 HEAD -- . ":(exclude).github" ":(exclude).gitignore" > last_commit_diff.txt
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞: –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç –ø—É—Å—Ç–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–µ—Ä–¥–∂), –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π –¥–∏—Ñ—Ñ –¥–ª—è –ª–æ–≥–∞
            if [ ! -s last_commit_diff.txt ]; then
               echo "Last commit diff is empty. Using full diff for changelog."
               cp full_pr_diff.txt last_commit_diff.txt
            fi
          else
            echo "Manual run." > full_pr_diff.txt
            echo "Manual run." > last_commit_diff.txt
          fi

          if [ -f "README.md" ]; then
            cp README.md current_readme.txt
          else
            echo "README.md file not found." > current_readme.txt
          fi
          
          git ls-files --exclude-standard | grep -v "^.github/" > file_tree.txt

      # ========================================================
      # üìù STEP 3: GENERATE CHANGE LOG (–£–ª—É—á—à–µ–Ω–æ)
      # ========================================================
      - name: 3. Generate Change Log
        id: changelog_gen
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cat <<'EOF_PROMPT' > changelog_prompt.txt
          # TASK: COMMIT ANALYST
          Analyze the code changes and write a concise Change Log.
          
          # RULES:
          1. Use bullet points with emojis (‚ú®, üêõ, üì¶, ‚öôÔ∏è).
          2. Be specific (mention file names or variable names).
          3. If the input is large, summarize the top 3 most important changes.
          4. DO NOT write intro text like "Here is the changelog". Just the list.
          EOF_PROMPT

          jq -n \
            --rawfile diff last_commit_diff.txt \
            --rawfile prompt changelog_prompt.txt \
            '{ contents: [{ parts: [{ text: ($prompt + "\n\n## CHANGES TO ANALYZE:\n" + $diff) }] }] }' > changelog_payload.json

          curl -s -H "Content-Type: application/json" \
               -d @changelog_payload.json \
               "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$GEMINI_API_KEY" > changelog_response.json

          jq -r '.candidates[0].content.parts[0].text' changelog_response.json > change_log.md

      # ========================================================
      # üîÑ STEP 4: GENERATE README
      # ========================================================
      - name: 4. Generate Full README
        id: readme_gen
        env:
          REPO_NAME: ${{ github.event.repository.name }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cat <<'EOF_PROMPT' > readme_prompt.txt
          # TASK: DOCUMENTATION MAINTAINER
          ## GOAL: Update `README.md` based on the code provided.
          
          ## RULES:
          1. **ALWAYS UPDATE:** Generate the full `README.md`.
          2. **INTEGRATION:** Merge new features.
          
          ## GOLDEN STRUCTURE:
          ---
          **[GOLDEN_TEMPLATE]**
          # PROJECT_NAME_PH
          [Description]
          ## 1. Table of Contents
          ## 2. About The Project
          ## 3. Installation
          ## 4. Usage
          ## 5. Configuration
          ## 6. API Reference
          ## 7. Deployment
          ## 8. Roadmap
          ## 9. License
          Copyright ¬© 2025 Grid Dynamics Holdings, Inc. All rights reserved.
          (Standard License Text...)
          ---
          
          Output ONLY the Markdown content.
          EOF_PROMPT

          sed -i "s/PROJECT_NAME_PH/$REPO_NAME/g" readme_prompt.txt
          
          jq -n \
            --arg repo "$REPO_NAME" \
            --rawfile diff full_pr_diff.txt \
            --rawfile readme current_readme.txt \
            --rawfile filetree file_tree.txt \
            --rawfile prompt readme_prompt.txt \
            '{ contents: [{ parts: [{ text: ($prompt + "\n\n## FILES:\n" + $filetree + "\n\n## README:\n" + $readme + "\n\n## FULL CODE DIFF:\n" + $diff) }] }] }' > readme_payload.json

          curl -s -H "Content-Type: application/json" -d @readme_payload.json "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=$GEMINI_API_KEY" > readme_response.json
          
          jq -r '.candidates[0].content.parts[0].text' readme_response.json | sed 's/^```json//' | sed 's/^```//' | sed 's/```$//' > gemini_output.txt

      # ========================================================
      # ü§ñ STEP 5: DECIDE ACTION (COMMENT OR COMMIT)
      # ========================================================
      - name: 5. Decide Action
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            if (!fs.existsSync('gemini_output.txt')) return;
            
            const readmeContent = fs.readFileSync('gemini_output.txt', 'utf8');
            let summary = "Documentation updated.";
            
            if (fs.existsSync('change_log.md')) {
               summary = fs.readFileSync('change_log.md', 'utf8');
            }

            const labels = context.payload.pull_request ? context.payload.pull_request.labels.map(l => l.name) : [];
            const shouldCommit = labels.includes('generate-readme');

            if (shouldCommit) {
              console.log("LABEL FOUND! Writing file to disk...");
              fs.writeFileSync('README.md', readmeContent);
            } else {
              console.log("No label found. Updating comment...");
              const header = "ü§ñ **Documentation Agent**";
              const body = `${header}\n\n### üìù –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å (Change Log):\n${summary}\n\n---\nüëâ **Apply?** Add label **\`generate-readme\`**.\n\n<details><summary>üëÄ View README Preview</summary>\n\n\`\`\`markdown\n${readmeContent}\n\`\`\`\n</details>`;
              
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              const botComment = comments.find(c => c.body.includes(header));
              if (botComment) {
                await github.rest.issues.updateComment({ owner: context.repo.owner, repo: context.repo.repo, comment_id: botComment.id, body: body });
              } else {
                await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body: body });
              }
            }

      # ========================================================
      # üíæ STEP 6: COMMIT (–¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è)
      # ========================================================
      - name: 6. Commit Changes
        if: contains(github.event.pull_request.labels.*.name, 'generate-readme')
        run: |
          git config --global user.name "Gemini Docs Agent"
          git config --global user.email "actions@github.com"
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to commit. Proceeding to remove label."
          else
            git commit -m "docs: auto-update README.md [skip ci]"
            git push
          fi

      # ========================================================
      # üßπ STEP 7: REMOVE LABEL (ALWAYS!)
      # ========================================================
      - name: 7. Remove Label Always
        if: always() && contains(github.event.pull_request.labels.*.name, 'generate-readme')
        uses: actions/github-script@v6
        with:
          script: |
            console.log("Cleaning up label...");
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: 'generate-readme'
              });
            } catch (e) {
              console.log("Label already removed or not found.");
            }
